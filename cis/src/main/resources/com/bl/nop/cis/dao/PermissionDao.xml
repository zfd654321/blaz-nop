<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.bl.nop.cis.dao.PermissionDao">
	<!-- 用户登录 -->
	<select id="getUserByUserNoAndPass" parameterType="java.lang.String" resultType="com.bl.nop.entity.sys.SysUser">
		SELECT * FROM bl_sys_user WHERE status=1 AND
		username=#{username} AND
		password=#{password}
	</select>
	<!-- 查询用户列表 -->
	<select id="findUserByPage" parameterType="java.util.Map" resultType="com.bl.nop.cis.dto.UserDto">
		SELECT u.*,r.`role_name` FROM bl_user u LEFT JOIN bl_role r ON
		u.`user_role_id`=r.`role_id`
		WHERE 1=1
		<if test="userId!=null and userId!=''">
			AND user_id like
			concat('%',#{userId},'%')
		</if>
		<if test="userName!=null and userName!=''">
			AND user_name like
			concat('%',#{userName},'%')
		</if>
		<if test="status!=null and status!=''">
			AND u.`status` =#{status}
		</if>
		<if test="type!=null and type!=''">
			AND user_type
			=#{type}
		</if>
		<if test="roleId!=null and roleId!=''">
			AND u.`user_role_id`
			=#{roleId}
		</if>
		order by updated_time desc
		LIMIT ${startNum},${pageSize}
	</select>
	<!-- 查询用户列表 -->
	<select id="findUserCount" parameterType="java.util.Map" resultType="int">
		select count(*)
		from bl_user where 1=1
		<if test="userId!=null and userId!=''">
			AND user_id like
			concat('%',#{userId},'%')
		</if>
		<if test="userName!=null and userName!=''">
			AND user_name like
			concat('%',#{userName},'%')
		</if>
		<if test="status!=null and status!=''">
			AND `status` =#{status}
		</if>
		<if test="type!=null and type!=''">
			AND user_type
			=#{type}
		</if>
	</select>
	<update id="updateUserStatus" parameterType="java.lang.String">
		update bl_user set
		`status`=#{status, jdbcType=VARCHAR} where user_id =
		#{userId,jdbcType=VARCHAR} AND `status`='Y'
	</update>

	<select id="findMenuByRoleId" parameterType="java.lang.String" resultType="com.bl.nop.dto.MenuTreeDto">
		SELECT t.id AS id,
		t.name AS `text`,
		t.href AS url,
		t.icon AS icon,
		t.parent AS parMenuId,
		t.odindex AS odindex
		FROM bl_sys_role_menu m
		LEFT JOIN
		bl_sys_menu t
		ON
		m.menu_id=t.id
		WHERE t.status=1
		AND m.role_id =
		#{roleId}
		ORDER BY t.parent,t.odindex
	</select>

	<select id="findMenuByMenuIds" resultType="com.bl.nop.entity.sys.SysMenu" parameterType="java.util.List">
		select * from bl_menu
		where t.status='Y' AND menu_id in
		<foreach collection="list" index="index" item="item" open="(" separator="," close=")">
			#{item}
		</foreach>
	</select>

	<!-- 查询所有的菜单 -->
	<select id="findAllMenu" resultType="com.bl.nop.entity.sys.SysMenu">
		SELECT * FROM bl_menu
		WHERE
		status='Y'
		ORDER BY ABS(menu_id)
	</select>

	<select id="findRoleByPage" parameterType="java.util.Map" resultType="com.bl.nop.entity.sys.SysRole">
		SELECT role_id,
		STATUS,
		role_desc,
		role_name,
		created_by,
		updated_by,
		created_time,
		updated_time
		FROM bl_role WHERE 1=1
		<if test="roleId!=null and roleId!=''">
			AND role_id like
			concat('%',#{role_id},'%')

		</if>
		<if test="roleName!=null and roleName!=''">
			AND role_name like
			concat('%',#{role_name},'%')
		</if>
		<if test="status!=null and status!=''">
			AND status =
			#{status}
		</if>
		order by role_id
	</select>

	<select id="findRoleCount" parameterType="java.util.Map" resultType="int">
		select count(*)
		from bl_role where 1=1
		<if test="roleId!=null and roleId!=''">
			AND role_id like
			concat('%',#{role_id},'%')

		</if>
		<if test="roleName!=null and roleName!=''">
			AND role_name like
			concat('%',#{role_name},'%')
		</if>
		<if test="status!=null and status!=''">
			AND status =
			#{status}
		</if>
	</select>

	<insert id="updateRoleMenu" parameterType="java.util.Map">
		INSERT INTO
		bl_role_menu (menu_id,role_id,STATUS)
		(SELECT menu_id,#{roleId,
		jdbcType=VARCHAR},"Y" FROM bl_menu WHERE CONCAT(",",#{menuIdStr,
		jdbcType=VARCHAR},",")
		LIKE CONCAT("%,",menu_id,",%"))


	</insert>


	<delete id="cleanRoleMenu" parameterType="java.util.Map">
		DELETE FROM
		bl_role_menu WHERE role_id = #{roleId,jdbcType=VARCHAR}
	</delete>


	<select id="findDeviceUser" parameterType="java.util.Map" resultType="com.bl.nop.cis.dto.UserDto">
		SELECT * FROM bl_user
		WHERE user_type='1'
		OR user_role_id =
		'004'

	</select>

	<delete id="cleanUserMenu" parameterType="java.util.Map">
		DELETE FROM
		`bl_merchant_user_menu` WHERE user_id = #{userId};

		
	</delete>

	<insert id="saveUserMenu" parameterType="java.util.Map">
		INSERT INTO `bl_merchant_user_menu`
		(`user_id`,
		`menu_id`)
		(SELECT #{userId} user_id,menu_id FROM `bl_merchant_menu` WHERE
		CONCAT(",",#{menuIds},",") LIKE CONCAT("%,",menu_id,",%") );
	</insert>

</mapper>