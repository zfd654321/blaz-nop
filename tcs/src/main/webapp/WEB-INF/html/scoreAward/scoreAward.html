<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=750,user-scalable=no" />
<title></title>
<script src="../../js/jquery-3.1.0.min.js"></script>
<script src="../../js/httpService.js"></script>
<script type="text/javascript"
	src="https://res.wx.qq.com/open/js/jweixin-1.0.0.js"></script>
<style>
* {
	padding: 0;
	margin: 0;
}

html {
	width: 750px;
	margin: 0 auto
}

.main {
	position: absolute;
	overflow: hidden;
	height: 1333px;
	width: 750px;
}

.botton {
	position: absolute;
	top: 660px;
	left: 265px;
	width: 230px;
	height: 70px;
}

.awardimg {
	position: absolute;
	top: 445px;
	width: 750px;
	text-align: center;
}
</style>
</head>
<body>
	<div class="main">
		<div class="awardimg">
			<img src="" height="200" />
		</div>
		<div class="botton"></div>
	</div>

	<script>
		var open_id = ""
		var order_id = ""
		$(function() {
			$.get(pageContextPath+'/wechat/jssdk/sign.do', '', function(data) {
				if (data.code != 0) {
					return;
				}
				var d = data.data;
				wx.config({
					appId : d.appId,
					timestamp : d.timestamp,
					nonceStr : d.nonceStr,
					signature : d.signature,
					jsApiList : [ 'addCard' ]
				});
			}, 'json')
			var code = getURLParams('code');
			sendRequest(pageContextPath+'/WXPay/getWXUserOpenId.do', {
				"code" : code
			}, function(jsonData) {
				if (jsonData.data == '1') {
					open_id = jsonData.open_id;
					var awards_id = getURLParams('awards_id');
					var device_id = getURLParams('device_id');
					var merchant_id = getURLParams('merchant_id');
					order_id = getURLParams('order_id');
					var randomCode = getURLParams('randomCode');
					sendRequest(pageContextPath+'/score/getScoreActivitiesAwards.do',
							{
								"open_id" : open_id,
								"awards_id" : awards_id,
								"device_id" : device_id,
								"merchant_id" : merchant_id,
								"order_id" : order_id,
								"randomCode" : randomCode
							}, function(jsonData2) {
								//var str = "";
								if (jsonData2.return_code == 1) {
									$(".main").css("background",
											"url(img/back_type1.jpg)");
									$(".botton").attr("onclick",
											"addCard(this)");
									$(".botton").attr("id",
											jsonData2.spoild.spoil_id);
									$(".awardimg img").attr("src",
											jsonData2.spoild.spoil_image_url);

								} else if (jsonData2.return_code == -1) {
									$(".main").css("background",
											"url(img/back_type-1.jpg)");
								} else if (jsonData2.return_code == -2) {
									$(".main").css("background",
											"url(img/back_type-2.jpg)");
								} else if (jsonData2.return_code == -3) {
									$(".main").css("background",
											"url(img/back_type-3.jpg)");
								}
								//$("#awardlist").html(str);

							});

				} else {
					alert("获取微信用户信息失败");
				}
			});
		});

		function addCard(_this) {
			var card_id = _this.id;
			$.get(pageContextPath+'/wechat/jssdk/sign1.do', {
				"cardId" : card_id
			}, function(JsonData) {
				var data = JsonData.data
				data.cancel = function() {
				};

				data.success = function() {
					//$(_this).addClass("done");
					//$(_this).html("已领取");
					$(_this).removeAttr("onclick");
					saveCardInfo(card_id);
				};

				wx.addCard(data);
			}, 'json')
		}

		function saveCardInfo(card_id) {
			var device_id = getURLParams("device_id");
			//var open_id = getURLParams("open_id");
			var awards_id = getURLParams("awards_id");
			var lottery_merchant_id = getURLParams("lottery_merchant_id");

			$.get(pageContextPath+'/score/saveSpoilCardVerification.do', 'order_id='
					+ order_id, function(data) {
				$("#spoil_image").attr("src", data.vo.spoil_image);
				$("#cardtitle").html(data.vo.spoil_name);
				$("#spoil_desc").html(data.vo.spoil_desc);
			}, 'json')
		}
	</script>
</body>
</html>