<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="viewport" content="width=750,user-scalable=no" />
<link href="css/index.css" rel="stylesheet" type="text/css" />
<script src="/BLWXV3.0/javascript/jquery-3.1.0.min.js"></script>
<script src="/BLWXV3.0/javascript/httpService.js"></script>
<script type="text/javascript"
	src="https://res.wx.qq.com/open/js/jweixin-1.0.0.js"></script>
<title>换装体验相册</title>
</head>
<body>
	<script type="text/javascript">
		var Ticket = getURLParams("Ticket");
		var code = getURLParams("code");
		var open_id = "";
		var device_id = getURLParams("device_id");
		var photo_order_id = getURLParams("photo_order_id");
		$(function() {
			sendRequest(
					'/BLWXV3.0/WXPay/getWXUserOpenId.do',
					{
						"code" : code
					},
					function(jsonData) {
						if (jsonData.data == '1') {
							open_id = jsonData.open_id;
							sendRequest(
									'/BLWXV3.0/wechat/getOpenPhotoNeedPayDevice.do',
									{
										"device_id" : device_id,
										"photo_order_id" : photo_order_id,
										"open_id" : open_id
									},
									function(jsonData) {
										if (jsonData.return_code == '-1') {
											goPhotoPage();
										} else if (jsonData.return_code == '-2') {
											goPhotoPage();
										} else if (jsonData.return_code == '1') {
											alert("支付后才能查看你的照片哦");
											prepay();
										} else {
											alert("系统出错1");
										}
									});
						} else {
							alert('得到微信用户信息Error!');
						}
					});

		});

		function goPhotoPage() {
			
			var url = "/BLWXV3.0//wechat/getWXUserPhotoInfos.do?type=2&content="+Ticket+"&open_id="+open_id;
			location.href = url;
		}

		function prepay() {
			sendRequest('/BLWXV3.0/wechat/openPhotoPayByWX.do', {
				"device_id" : device_id,
				"photo_order_id" : photo_order_id,
				"open_id" : open_id

			}, function(jsonData) {
				var returndata = jsonData.data;
				var keyPhotoOrderId = jsonData.keyPhotoOrderId;
				var dataMap = jsonData.dataMap;
				if (returndata == "1") {

					onBridgeReady(dataMap, keyPhotoOrderId);
				} else {
					alert("统一下单失败");
				}
			});
		}

		function onBridgeReady(data, keyPhotoOrderId) {
			WeixinJSBridge.invoke('getBrandWCPayRequest', {
				"appId" : data.appId, //公众号名称，由商户传入     
				"timeStamp" : data.timeStamp, //时间戳，自1970年以来的秒数     
				"nonceStr" : data.nonceStr, //随机串     
				"package" : data.prepay_id,
				"signType" : data.signType, //微信签名方式：     
				"paySign" : data.paySign
			//微信签名 
			}, function(res) {
				
				if (res.err_msg == "get_brand_wcpay_request:cancel"
						|| res.err_msg == "get_brand_wcpay_request:fail") {
					alert("调微信支付失败!");
					//$("#bos").hide();
				} // 使用以上方式判断前端返回,微信团队郑重提示：res.err_msg将在用户支付成功后返回    ok，但并不保证它绝对可靠。
				else {//支付成功
					callBackWXPay(keyPhotoOrderId);
					//alert("支付成功")
				}
			});
		}

		function callBackWXPay(keyPhotoOrderId) {
			var url = "/BLWXV3.0/wechat/callBackOpenPhotoPayByWX";
			var openId = open_id;
			sendRequest(url, {
				"keyPhotoOrderId" : keyPhotoOrderId,
				"openId" : openId
			}, function(jsonData) {
				if (jsonData.return_code == 1) {//说明 支付成功
					alert("支付成功");
					goPhotoPage();
				}
			});
			$("#bos").hide();
		}
	</script>
</body>
</html>