<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="viewport" content="width=750,user-scalable=no" />
    <link href="css/index.css" rel="stylesheet" type="text/css" />
    <script src="../../js/jquery-3.1.0.min.js"></script>
    <script src="../../js/httpService.js"></script>
    <script type="text/javascript" src="https://res.wx.qq.com/open/js/jweixin-1.0.0.js"></script>
    <title>换装体验相册</title>
</head>

<body>
    <script type="text/javascript">
        var content = getURLParams("content");
        var code = getURLParams("code");
        var open_id = "";
        var device_id = getURLParams("device_id");
        var order_id = getURLParams("game_pay_order_id");
        var type = getURLParams("type");
        var html_tag = getURLParams("html_tag");

        $(function() {
            sendRequest(
                pageContextPath + '/WXPay/getWXUserOpenId.do', {
                    "code": code
                },
                function(jsonData) {
                    if (jsonData.data == '1') {
                        open_id = jsonData.open_id;
                        sendRequest(
                            pageContextPath + '/miniPro/photo/getIsCosplayPhotoNeedPayDevice.do', {
                                "device_id": device_id,
                                "html_tag": html_tag,
                                "order_id": order_id,
                                "open_id": open_id
                            },
                            function(jsonData) {
                                if (jsonData.return_code == '-1') {
                                    goPhotoPage();
                                } else if (jsonData.return_code == '-2') {
                                    goPhotoPage();
                                } else if (jsonData.return_code == '1') {
                                    alert("支付后才能查看你的照片哦");
                                    prepay();
                                } else {
                                    alert("系统出错1");
                                }
                            });
                    } else {
                        alert('得到微信用户信息Error!');
                    }
                });

        });

        function goPhotoPage() {
            var url = pageContextPath + "/miniPro/photo/getCosplayPhotoInfos.do?&content=" +
                content + "&open_id=" + open_id + "&order_id=" + order_id + "&type=" + type + "&html_tag=" + html_tag;
            location.href = url;
        }

        function prepay() {
            sendRequest(pageContextPath + '/cosplay/cosplayPhotoPayByWX.do', {
                "device_id": device_id,
                "html_tag": html_tag,
                "order_id": order_id,
                "open_id": open_id

            }, function(jsonData) {
                var returndata = jsonData.data;
                var cosPlayPhotoOrderId = jsonData.cosPlayPhotoOrderId;
                var dataMap = jsonData.dataMap;
                if (returndata == "1") {

                    onBridgeReady(dataMap, cosPlayPhotoOrderId);
                } else {
                    alert("统一下单失败");
                }
            });
        }

        function onBridgeReady(data, cosPlayPhotoOrderId) {
            WeixinJSBridge.invoke('getBrandWCPayRequest', {
                "appId": data.appId, //公众号名称，由商户传入     
                "timeStamp": data.timeStamp, //时间戳，自1970年以来的秒数     
                "nonceStr": data.nonceStr, //随机串     
                "package": data.prepay_id,
                "signType": data.signType, //微信签名方式：     
                "paySign": data.paySign
                    //微信签名 
            }, function(res) {

                if (res.err_msg == "get_brand_wcpay_request:cancel" ||
                    res.err_msg == "get_brand_wcpay_request:fail") {
                    alert("调微信支付失败!");
                    //$("#bos").hide();
                } // 使用以上方式判断前端返回,微信团队郑重提示：res.err_msg将在用户支付成功后返回    ok，但并不保证它绝对可靠。
                else { //支付成功
                    callBackWXPay(cosPlayPhotoOrderId);
                    //alert("支付成功")
                }
            });
        }

        function callBackWXPay(cosPlayPhotoOrderId) {
            var url = pageContextPath + "/cosplay/callBackCosplayPhotoPayByWX";
            var openId = open_id;
            sendRequest(url, {
                "html_tag": html_tag,
                "order_id": order_id,
                "openId": openId
            }, function(jsonData) {
                if (jsonData.return_code == 1) { //说明 支付成功
                    alert("支付成功");
                    goPhotoPage();
                }
            });
            $("#bos").hide();
        }
    </script>
</body>

</html>